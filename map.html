<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Glyphbound: Sector Map</title> <link rel="stylesheet" href="style.css" />
  <style>
    /* ... (Keep your existing CSS) ... */
    
    /* NEW: DATA MODAL STYLES */
    #data-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(2, 6, 23, 0.95); z-index: 10000;
        display: none; flex-direction: column; align-items: center; justify-content: center;
    }
    #data-box {
        background: #0f172a; border: 1px solid #334155; padding: 2rem;
        border-radius: 12px; width: 90%; max-width: 400px; text-align: center;
        box-shadow: 0 0 30px rgba(0,0,0,0.5);
    }
    .data-textarea {
        width: 100%; height: 100px; background: #020617; border: 1px solid #1e293b;
        color: #38bdf8; font-family: monospace; font-size: 0.8rem; padding: 10px;
        margin: 10px 0; resize: none; word-break: break-all;
    }
    .data-btn {
        width: 48%; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; border: none;
    }
    .btn-save { background: #38bdf8; color: #000; }
    .btn-load { background: #334155; color: #fff; border: 1px solid #475569; }
  </style>
</head>

<body id="map-screen">

  <div id="map-header">
    <div class="header-top">
      <h1 id="map-title">GLYPHBOUND // MAP</h1> 
      <div class="nav-actions">
        <button class="nav-btn" onclick="openDataMenu()">DATA</button>
        <button class="nav-btn" onclick="window.location.href='shop.html'">DEPOT</button>
        <button class="nav-btn" onclick="window.location.href='index.html'">LOGOUT</button>
      </div>
    </div>
    
    <div id="map-currencies">
      <div class="currency" style="border-color:#facc15; color:#facc15">âš¡ <span id="energy-amt">--</span></div>
      <div class="currency" style="border-color:#0ea5e9; color:#0ea5e9">ðŸ’Ž <span id="prisma-amt">--</span></div>
      <div class="currency" style="border-color:#f472b6; color:#f472b6">ðŸª™ <span id="aurum-amt">--</span></div>
      <div style="color:#64748b; margin-left:8px; display:flex; align-items:center;">
        REGEN: <span id="energy-timer" style="margin-left:4px; color:#fff;">--:--</span>
      </div>
    </div>
  </div>

  <div id="sector-visualizer">
    <svg id="radar-svg" viewBox="0 0 200 200">
      <circle cx="100" cy="100" r="20" class="radar-ring boss-zone" id="ring-4" />
      <path d="M 100,100 m -40,0 a 40,40 0 1,0 80,0 a 40,40 0 1,0 -80,0" class="radar-ring" id="ring-3" />
      <path d="M 100,100 m -60,0 a 60,60 0 1,0 120,0 a 60,60 0 1,0 -120,0" class="radar-ring" id="ring-2" />
      <path d="M 100,100 m -80,0 a 80,80 0 1,0 160,0 a 80,80 0 1,0 -160,0" class="radar-ring" id="ring-1" />
      <path d="M 100,100 m -96,0 a 96,96 0 1,0 192,0 a 96,96 0 1,0 -192,0" class="radar-ring" id="ring-0" />
    </svg>
    <div class="zone-info-panel">SECTOR SCAN: <span id="active-zone-name">LOADING...</span></div>
  </div>

  <div class="zone-tabs-container" id="zone-tabs"></div>
  <div id="zones-display" class="zones-display"></div>

  <div id="data-modal">
      <div id="data-box">
          <h3 style="color:#fff; margin-top:0;">DATA MANAGEMENT</h3>
          <p style="font-size:0.8rem; color:#94a3b8;">Copy code to save. Paste code to load.</p>
          <textarea id="save-string" class="data-textarea" placeholder="Paste Save Code Here..."></textarea>
          <div style="display:flex; justify-content:space-between; margin-top:10px;">
              <button class="data-btn btn-save" onclick="generateSave()">GET SAVE CODE</button>
              <button class="data-btn btn-load" onclick="loadSave()">LOAD DATA</button>
          </div>
          <button onclick="document.getElementById('data-modal').style.display='none'" style="margin-top:15px; background:none; border:none; color:#64748b; cursor:pointer; text-decoration:underline;">CLOSE</button>
      </div>
  </div>

  <script src="state.js"></script>
  <script src="economy.js"></script>
  <script src="levels.js"></script>
  <script src="audio.js"></script>
  <script src="save_system.js"></script> 
  
  <script>
    // --- SAVE LOGIC ---
    function openDataMenu() {
        document.getElementById('data-modal').style.display = 'flex';
        document.getElementById('save-string').value = ""; 
    }

    function generateSave() {
        if(!window.SaveSys) return alert("System Loading...");
        const code = SaveSys.exportData();
        const area = document.getElementById('save-string');
        area.value = code;
        area.select();
        document.execCommand('copy'); 
        alert("CODE COPIED TO CLIPBOARD!");
    }

    function loadSave() {
        if(!window.SaveSys) return alert("System Loading...");
        const code = document.getElementById('save-string').value.trim();
        if(!code) return alert("Please paste a code first.");
        if(confirm("Overwrite current progress?")) {
            SaveSys.importData(code);
        }
    }

    // --- MAP LOGIC ---
    (function() {
      const ZONES = ["OUTSKIRTS", "INDUSTRIAL", "ECO-SECTOR", "HIGH-TECH", "CORE"];
      const allLevels = window.LEVELS || [];
      const unlocked = parseInt(localStorage.getItem("levelUnlocked") || "1", 10);
      
      const tabsEl = document.getElementById("zone-tabs");
      const displayEl = document.getElementById("zones-display");
      const zoneNameEl = document.getElementById("active-zone-name");

      if (window.AudioSys) AudioSys.playBGM('bgm_map');

      const zoneData = [[], [], [], [], []];
      allLevels.forEach(l => {
        const zIndex = Math.floor((l.id - 1) / 10);
        if(zoneData[zIndex]) zoneData[zIndex].push(l);
      });

      ZONES.forEach((name, i) => {
        const tab = document.createElement("div");
        tab.className = "zone-tab";
        tab.innerText = `Z${i+1}: ${name}`;
        tab.onclick = () => switchZone(i);
        tabsEl.appendChild(tab);

        const container = document.createElement("div");
        container.className = "zone-content";
        const grid = document.createElement("div");
        grid.className = "hex-grid";
        
        // Safety check if zoneData[i] exists
        if(zoneData[i]) {
            zoneData[i].forEach(lvl => {
              const isLocked = lvl.id > unlocked;
              const isBoss = (lvl.id % 10 === 0);
              
              const hex = document.createElement("div");
              let classes = "hex-node";
              if(isBoss) classes += " boss";
              if(isLocked) classes += " locked";
              if(lvl.id < unlocked) classes += " completed";
              
              hex.className = classes;
              hex.innerHTML = `<span class="lvl-id">${lvl.id}</span><span class="lvl-label">${isLocked?"LOCK":(isBoss?"BOSS":"SEC")}</span>`;
              
              if(!isLocked) {
                hex.onclick = () => {
                  if (window.economy && window.economy.spendEnergyForLevel()) {
                    window.location.href = `game.html?level=${lvl.id}`;
                  } else if (confirm("Low Energy. Visit Supply Depot?")) {
                    window.location.href = "shop.html";
                  }
                };
              }
              grid.appendChild(hex);
            });
        }
        container.appendChild(grid);
        displayEl.appendChild(container);
      });

      function switchZone(idx) {
        document.querySelectorAll(".zone-tab").forEach((t, i) => t.classList.toggle("active", i === idx));
        document.querySelectorAll(".zone-content").forEach((c, i) => c.classList.toggle("active", i === idx));
        document.querySelectorAll(".radar-ring").forEach((r, i) => r.classList.toggle("active", i === idx));
        zoneNameEl.innerText = ZONES[idx];
      }

      let currentZoneIdx = Math.floor((unlocked - 1) / 10);
      if(currentZoneIdx > 4) currentZoneIdx = 4;
      switchZone(currentZoneIdx);

      function updateHUD() {
        if(!window.economy) return;
        economy.regenerateEnergy();
        document.getElementById("energy-amt").textContent = economy.getEnergy();
        document.getElementById("prisma-amt").textContent = economy.getPrisma();
        document.getElementById("aurum-amt").textContent = economy.getAurum();
        
        const el = document.getElementById("energy-timer");
        if(economy.getEnergy() >= economy.maxEnergy) {
           el.textContent = "MAX";
        } else {
           const last = parseInt(localStorage.getItem(economy.LS_KEYS.lastEnergyAt)||Date.now());
           const next = last + (economy.regenMinutes*60000);
           const diff = next - Date.now();
           if(diff <= 0) { economy.regenerateEnergy(); updateHUD(); }
           else {
             const m = Math.floor(diff/60000);
             const s = Math.floor((diff%60000)/1000);
             el.textContent = `${m}:${s.toString().padStart(2,'0')}`;
           }
        }
      }
      setInterval(updateHUD, 1000);
      updateHUD();
    })();
  </script>
</body>
</html>